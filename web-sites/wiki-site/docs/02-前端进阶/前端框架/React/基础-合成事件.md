# åŸºç¡€-åˆæˆäº‹ä»¶


## äº‹ä»¶å§”æ‰˜

åœ¨jsä¸­, äº‹ä»¶å§”æ‰˜(Event Delegation)æ˜¯ä¸€ç§äº‹ä»¶å“åº”æœºåˆ¶, å½“éœ€è¦ç›‘å¬ä¸å­˜åœ¨çš„å…ƒç´ æˆ–è€…æ˜¯åŠ¨æ€ç”Ÿæˆå…ƒç´ çš„æ—¶å€™, å°±å¯ä»¥è€ƒè™‘äº‹ä»¶å§”æ‰˜. 

äº‹ä»¶å§”æ‰˜å¾—ç›Šäºäº‹ä»¶å†’æ³¡, å½“ç›‘å¬å­å…ƒç´ çš„æ—¶å€™, äº‹ä»¶å†’æ³¡ä¼šé€šè¿‡ç›®æ ‡å…ƒç´ å‘ä¸Šä¼ é€’åˆ°çˆ¶çº§, ç›´åˆ°document, å¦‚æœå­å…ƒç´ ä¸ç¡®å®šæˆ–è€…åŠ¨æ€ç”Ÿæˆ, å¯ä»¥é€šè¿‡ç›‘å¬çˆ¶å…ƒç´ æ¥å–ä»£ç›‘å¬å­å…ƒç´ .

äº‹ä»¶å§”æ‰˜å¯ä»¥é€šè¿‡ç›‘å¬çˆ¶çº§æ¥è¾¾åˆ°ç›‘å¬å­çº§çš„æ•ˆæœ, å‡å°‘ç›‘å¬çš„æ•°é‡, ä½¿ç”¨æ›´å°‘çš„å†…å­˜. å¯ä»¥éšæ„çš„å¯¹å­å…ƒç´ è¿›è¡Œäº‹ä»¶ç»‘å®šä¹Ÿä¸ç”¨æ‹…å¿ƒå¿˜è®°è§£ç»‘.

Reactä¸­ä¸ä½†åˆ©ç”¨äº†è¿™å¥—æœºåˆ¶, è¿˜è‡ªèº«å®ç°äº†ä¸€å¥—è‡ªå·±çš„äº‹ä»¶æœºåˆ¶, æ¶ˆé™¤äº†ä¸åŒæµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚. 

Reactå®ç°äº†ä¸€ä¸ªåˆæˆäº‹ä»¶å±‚, åˆ©ç”¨è¿™ä¸ªäº‹ä»¶å±‚æŠŠIEå’ŒW3Cæ ‡å‡†ä¹‹é—´çš„å…¼å®¹é—®é¢˜æ¶ˆé™¤äº†. 

## åˆæˆäº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶

- åŸç”Ÿäº‹ä»¶: åœ¨`componentDidMount`ä¸­è¿›è¡Œ`addEventListener`ç»‘å®šçš„äº‹ä»¶
- åˆæˆäº‹ä»¶: é€šè¿‡JSXæ–¹å¼ç»‘å®šçš„æ—¶é—´, æ¯”å¦‚`onClick={()=> this.handle()}`

æ¯”å¦‚è¿™æ®µä»£ç ä¸­:

```js
{
  this.state.showBox && <div onClick={e => e.stopPropagation()}>æˆ‘æ˜¯å¼¹çª—</div>
}
```

ç„¶ååœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¯¹bodyè¿›è¡Œç»‘å®š:

```js
componentDidMount() {
  document.body.addEventListener('click', this.handleClickBody, false)
}

componentWillUnmount() {
  document.body.removeEventListener('click', this.handleClickBody, false)
}
```

å› ä¸ºåˆæˆäº‹ä»¶çš„è§¦å‘æ—¶åŸºäºæµè§ˆå™¨çš„äº‹ä»¶æœºåˆ¶å®ç°çš„, é€šè¿‡å†’æ³¡æœºåˆ¶åˆ°æœ€é¡¶å±‚å…ƒç´ , ç„¶åå†ç”±dispatchEventç»Ÿä¸€å¤„ç†. 

![image](/assets/2021-3-9/awkdx-bq416.jpg)

æµè§ˆå™¨çš„äº‹ä»¶æ‰§è¡Œéœ€è¦ç»è¿‡ä¸‰ä¸ªé˜¶æ®µ: `æ•è·é˜¶æ®µ-ç›®æ ‡å…ƒç´ é˜¶æ®µ-å†’æ³¡é˜¶æ®µ`

æ­¤æ—¶å¯¹äºåˆæˆäº‹ä»¶è¿›è¡Œé˜»æ­¢, åŸç”Ÿäº‹ä»¶ä¼šæ‰§è¡Œå—? 

ä¼š, å› ä¸º**åŸç”Ÿäº‹ä»¶å…ˆäºåˆæˆäº‹ä»¶æ‰§è¡Œ**. 

## åˆæˆäº‹ä»¶ç‰¹ç‚¹

- React æ³¨å†Œçš„äº‹ä»¶æœ€ç»ˆä¼šç»‘å®šåˆ°documentè¿™ä¸ªdomä¸Š, è€Œä¸æ˜¯reactç»„ä»¶å¯¹åº”çš„dom(å‡å°‘å†…å­˜å¼€é”€å°±æ˜¯å› ä¸ºæ‰€æœ‰çš„äº‹ä»¶éƒ½ç»‘å®šåœ¨äº†documentä¸Š, å…¶ä»–çš„èŠ‚ç‚¹æ²¡æœ‰ç»‘å®šäº‹ä»¶)
- React è‡ªèº«å®ç°äº†ä¸€å¥—äº‹ä»¶å†’æ³¡æœºåˆ¶, æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„`e.stopPropagation()`æ— æ•ˆçš„åŸå› .
- React é€šè¿‡é˜Ÿåˆ—çš„å½¢å¼, ä»è§¦å‘çš„ç»„ä»¶å‘çˆ¶ç»„ä»¶å›æº¯, ç„¶åè°ƒç”¨ä»–ä»¬JSXä¸­å®šä¹‰çš„callback.
- React æœ‰ä¸€å¥—è‡ªå·±çš„åˆæˆäº‹ä»¶`SyntheticEvent`, ä¸æ˜¯åŸç”Ÿçš„
- React é€šè¿‡å¯¹è±¡æ± çš„å½¢å¼ç®¡ç†åˆæˆäº‹ä»¶å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯, å‡å°‘äº†åƒåœ¾çš„ç”Ÿæˆå’Œæ–°å¯¹è±¡å†…å­˜çš„åˆ†é…, æé«˜äº†æ€§èƒ½.

## React äº‹ä»¶ç³»ç»Ÿ

äº‹ä»¶ç³»ç»Ÿçš„æºç åœ°å€åœ¨[è¿™é‡Œ](https://github.com/facebook/react/blob/9198a5cec0936a21a5ba194a22fcbac03eba5d1d/packages/react-native-renderer/src/ReactNativeEventEmitter.js)

å¤§æ¦‚çš„åˆæˆç³»ç»Ÿæ¡†æ¶å¦‚ä¸‹:

```
/**
 * Reactå’Œäº‹ä»¶ç³»ç»Ÿæ¦‚è¿°:
 *
 * +------------+    .
 * |    DOM     |    .
 * +------------+    .
 *       |           .
 *       v           .
 * +------------+    .
 * | ReactEvent |    .
 * |  Listener  |    .
 * +------------+    .                         +-----------+
 *       |           .               +--------+|SimpleEvent|
 *       |           .               |         |Plugin     |
 * +-----|------+    .               v         +-----------+
 * |     |      |    .    +--------------+                    +------------+
 * |     +-----------.--->|EventPluginHub|                    |    Event   |
 * |            |    .    |              |     +-----------+  | Propagators|
 * | ReactEvent |    .    |              |     |TapEvent   |  |------------|
 * |  Emitter   |    .    |              |<---+|Plugin     |  |other plugin|
 * |            |    .    |              |     +-----------+  |  utilities |
 * |     +-----------.--->|              |                    +------------+
 * |     |      |    .    +--------------+
 * +-----|------+    .                ^        +-----------+
 *       |           .                |        |Enter/Leave|
 *       +           .                +-------+|Plugin     |
 * +-------------+   .                         +-----------+
 * | application |   .
 * |-------------|   .
 * |             |   .
 * |             |   .
 * +-------------+   .
 *                   .
 */
```

ç®€å•çš„æ¥è¯´:

- `Top-level delegation` ç”¨äºæ•è·æœ€åŸå§‹çš„æµè§ˆå™¨äº‹ä»¶, å®ƒä¸»è¦ç”±`ReactEventListener`è´Ÿè´£, `ReactEventListener`è¢«æ³¨å…¥åå¯ä»¥æ”¯æŒæ’ä»¶åŒ–çš„äº‹ä»¶æº, è¿™ä¸€è¿‡ç¨‹å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹. 
- Reactå¯¹äº‹ä»¶è¿›è¡Œè§„èŒƒåŒ–å’Œé‡å¤æ•°æ®åˆ é™¤, ä»¥è§£å†³æµè§ˆå™¨çš„å·®å¼‚æ€§
- å°†è¿™äº›æœ¬åœ°äº‹ä»¶è½¬å‘åˆ°`EventPluginHub`, åè€…å°†è¯¢é—®æ’ä»¶æ˜¯å¦è¦æå–ä»»ä½•äº‹ä»¶
- `EventPluginPub`å°†ä¸ºæ¯ä¸ªäº‹ä»¶æ·»åŠ `dispatches`æ¥å¯¹å…¶è¿›è¡Œæ³¨é‡Šå’Œå¤„ç†
- `EventPluginHub`ä¼šè°ƒåº¦åˆ†æ´¾äº‹ä»¶.

ä»åç§°å¯ä»¥çœ‹å‡º:

- ReactEventListener: è´Ÿè´£äº‹ä»¶çš„æ³¨å†Œ
- ReactEventEmitter: è´Ÿè´£äº‹ä»¶çš„åˆ†å‘
- EventPluginHub: è´Ÿè´£äº‹ä»¶çš„å­˜å‚¨ä»¥åŠåˆ†å‘
- Pluginï¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹æ„é€ ä¸åŒçš„åˆæˆäº‹ä»¶

ä¸‹é¢å°±åˆ†åˆ«çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

## äº‹ä»¶æ³¨å†Œ

Reactä¸­æ³¨å†Œä¸€ä¸ªäº‹ä»¶éå¸¸ç®€å•, æ¯”å¦‚:

```js
class TaskEvent extends Reac.PureComponent {
  render() {
    return (
      <div
        onClick={() => {
          console.log('æˆ‘æ˜¯æ³¨å†Œäº‹ä»¶')
        }}
      >
        å‘µå‘µå‘µ
      </div>
    )
  }
}
```

ç»„ä»¶åœ¨åˆ›å»º`mountComponent`å’Œæ›´æ–°`updateComponent`çš„æ—¶å€™, éƒ½ä¼šè°ƒç”¨`_updateDOMProperties()`æ–¹æ³•.

```js
mountComponent: function(transaction, hostParent, hostContainerInfo, context) {
  // ...
  var props = this._currentElement.props;
  // ...
  this._updateDOMProperties(null, props, transaction);
  // ...
}
```

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­:

```js
_updateDOMProperties: function (lastProps, nextProps, transaction) {
    // ...
    for (propKey in nextProps) {
      var nextProp = nextProps[propKey];
      var lastProp = propKey === STYLE ? this._previousStyleCopy : lastProps != null ? lastProps[propKey] : undefined;
      if (!nextProps.hasOwnProperty(propKey) || nextProp === lastProp || nextProp == null && lastProp == null) {
        continue;
      }
      if (propKey === STYLE) {
        // ...
      } else if (registrationNameModules.hasOwnProperty(propKey)) {
        // å¦‚æœæ˜¯propsè¿™ä¸ªå¯¹è±¡ç›´æ¥å£°æ˜çš„å±æ€§ï¼Œè€Œä¸æ˜¯ä»åŸå‹é“¾ä¸­ç»§æ‰¿è€Œæ¥çš„ï¼Œåˆ™å¤„ç†å®ƒ
        // å¯¹äºmountComponentï¼ŒlastPropä¸ºnullã€‚updateComponentäºŒè€…éƒ½ä¸ä¸ºnullã€‚unmountComponentåˆ™nextPropä¸ºnull
        if (nextProp) {
          // mountComponentå’ŒupdateComponentä¸­ï¼ŒenqueuePutListeneræ³¨å†Œäº‹ä»¶
          enqueuePutListener(this, propKey, nextProp, transaction);
        } else if (lastProp) {
          // unmountComponentä¸­ï¼Œåˆ é™¤æ³¨å†Œçš„listenerï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
          deleteListener(this, propKey);
        }
      }
    }
}
```

### enqueuePutListener

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­, ä¼šé€šè¿‡`enqueuePutListener()`æ–¹æ³•è¿›è¡Œæ³¨å†Œäº‹ä»¶, æˆ‘ä»¬æ¥ç€çœ‹çœ‹è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„æ‰§è¡Œé€»è¾‘:

```js
function enqueuePutListener(inst, registrationName, listener, transaction) {
  if (transaction instanceof ReactServerRenderingTransaction) {
    return
  }
  var containerInfo = inst._hostContainerInfo
  var isDocumentFragment =
    containerInfo._node && containerInfo._node.nodeType === DOC_FRAGMENT_TYPE
  // æ‰¾åˆ°document
  var doc = isDocumentFragment
    ? containerInfo._node
    : containerInfo._ownerDocument
  // æ³¨å†Œäº‹ä»¶ï¼Œå°†äº‹ä»¶æ³¨å†Œåˆ°documentä¸Š
  listenTo(registrationName, doc)
  // å­˜å‚¨äº‹ä»¶,æ”¾å…¥äº‹åŠ¡é˜Ÿåˆ—ä¸­
  transaction.getReactMountReady().enqueue(putListener, {
    inst: inst,
    registrationName: registrationName,
    listener: listener
  })
}
```

è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†ä¸¤ä»¶äº‹:

- é€šè¿‡è°ƒç”¨`listenTo`æŠŠæ—¶é—´æ³¨å†Œåˆ°documentä¸Š
- äº‹åŠ¡æ–¹å¼è°ƒç”¨`putListener`å­˜å‚¨äº‹ä»¶(å°±æ˜¯æŠŠReactç»„ä»¶å†…çš„æ‰€æœ‰äº‹ä»¶ç»Ÿä¸€çš„å­˜æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œé¢, ç¼“å­˜èµ·æ¥, ä¸ºäº†åœ¨å‡ºå‘äº‹ä»¶çš„æ—¶å€™å¯ä»¥æŸ¥åˆ°å¯¹åº”çš„æ–¹æ³•å»æ‰§è¡Œ)

é‚£ä¹ˆ`listenTo()`ä¸­æ˜¯å¦‚ä½•åšçš„å‘¢?

### listenTo

```js
export function listenTo(
  registrationName: string,
  mountAt: Document | Element | Node
): void {
  const listeningSet = getListeningSetForElement(mountAt)
  const dependencies = registrationNameDependencies[registrationName]

  for (let i = 0; i < dependencies.length; i++) {
    const dependency = dependencies[i]
    // è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œæ³¨å†Œ
    listenToTopLevel(dependency, mountAt, listeningSet)
  }
}
```

`registerationName`å°±æ˜¯ä¼ é€’è¿‡æ¥çš„`onClick`, è€Œå˜é‡`registrationNameDependencies`æ˜¯ä¸€ä¸ªå­˜å‚¨äº†Reactäº‹ä»¶åå’Œæµè§ˆå™¨åŸç”Ÿäº‹ä»¶åå¯¹åº”çš„ä¸€ä¸ªMap, å¯ä»¥é€šè¿‡è¿™ä¸ªmapæ‹¿åˆ°å“åº”çš„æµè§ˆå™¨åŸç”Ÿäº‹ä»¶åç§°.

```js
export function listenToTopLevel(
  topLevelType: DOMTopLevelEventType,
  mountAt: Document | Element | Node,
  listeningSet: Set<DOMTopLevelEventType | string>
): void {
  if (!listeningSet.has(topLevelType)) {
    switch (topLevelType) {
      //...
      case TOP_CANCEL:
      case TOP_CLOSE:
        if (isEventSupported(getRawEventName(topLevelType))) {
          trapCapturedEvent(topLevelType, mountAt) // æ•è·é˜¶æ®µ
        }
        break
      default:
        const isMediaEvent = mediaEventTypes.indexOf(topLevelType) !== -1
        if (!isMediaEvent) {
          trapBubbledEvent(topLevelType, mountAt) // å†’æ³¡é˜¶æ®µ
        }
        break
    }
    listeningSet.add(topLevelType)
  }
}
```

å¿½ç•¥å…¶ä»–ä¸é‡è¦çš„æºç  , æˆ‘ä»¬çœ‹åˆ°æ³¨å†Œäº‹ä»¶çš„å…¥å£æ˜¯listenToæ–¹æ³•, é€šè¿‡å¯¹`dependencies`å¾ªç¯è°ƒç”¨`listenToTopLevel`æ–¹æ³•, åœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨ `trapCapturedEvent` å’Œ `trapBubbledEvent` æ¥æ³¨å†Œæ•è·å’Œå†’æ³¡äº‹ä»¶.

### trapCapturedEvent å’Œ trapBubbledEvent

æˆ‘ä»¬å¯¹`trapCapturedEvent`è¿›è¡Œåˆ†æ:

```js
// æ•è·é˜¶æ®µ
export function trapCapturedEvent(
  topLevelType: DOMTopLevelEventType,
  element: Document | Element | Node
): void {
  trapEventForPluginEventSystem(element, topLevelType, true)
}

// å†’æ³¡é˜¶æ®µ
export function trapBubbledEvent(
  topLevelType: DOMTopLevelEventType,
  element: Document | Element | Node
): void {
  trapEventForPluginEventSystem(element, topLevelType, false)
}
```

å‘ç°ä¸¤è€…éƒ½æ˜¯è°ƒç”¨å¦‚ä¸‹æ–¹æ³•:

```js
function trapEventForPluginEventSystem(
  element: Document | Element | Node,
  topLevelType: DOMTopLevelEventType,
  capture: boolean // å†³å®šæ•è·è¿˜æ˜¯å†’æ³¡é˜¶æ®µ
): void {
  let listener
  switch (getEventPriority(topLevelType)) {
  }
  const rawEventName = getRawEventName(topLevelType)
  if (capture) {
    //   æ•è·äº‹ä»¶
    addEventCaptureListener(element, rawEventName, listener)
  } else {
    //   å†’æ³¡äº‹ä»¶
    addEventBubbleListener(element, rawEventName, listener)
  }
}
```

è¿™é‡Œæˆ‘ä»¬å°±èƒ½çŸ¥é“, æ•è·äº‹ä»¶é€šè¿‡`addEventCaptureListener()`, è€Œå†’æ³¡äº‹ä»¶é€šè¿‡`addEventBubbleListener()`.

```js
// æ•è·
export function addEventCaptureListener(
  element: Document | Element | Node,
  eventType: string,
  listener: Function
): void {
  element.addEventListener(eventType, listener, true)
}

// å†’æ³¡
export function addEventBubbleListener(
  element: Document | Element | Node,
  eventType: string,
  listener: Function
): void {
  element.addEventListener(eventType, listener, false)
}
```

åˆ°è¿™é‡Œ, äº‹ä»¶çš„æ³¨å†Œæµç¨‹å°±å®Œæˆäº†. 

ä¸‹é¢å°±æ˜¯æŠŠæ³¨å†Œçš„æ—¶é—´å­˜å‚¨èµ·æ¥:

## äº‹ä»¶å­˜å‚¨

åœ¨ä¸Šé¢çš„`enqueuePutListener()`æ–¹æ³•ä¸­, æˆ‘ä»¬æŠŠäº‹ä»¶æ”¾å…¥åˆ°äº‹åŠ¡é˜Ÿåˆ—ä¸­:

```js
function enqueuePutListener(inst, registrationName, listener, transaction) {
  //...
  // æ³¨å†Œäº‹ä»¶ï¼Œå°†äº‹ä»¶æ³¨å†Œåˆ°documentä¸Š
  listenTo(registrationName, doc)
  // å­˜å‚¨äº‹ä»¶,æ”¾å…¥äº‹åŠ¡é˜Ÿåˆ—ä¸­
  transaction.getReactMountReady().enqueue(putListener, {
    inst: inst,
    registrationName: registrationName,
    listener: listener
  })
}
```

å…¶ä¸­çš„`putListener`, å®ç°äº†äº‹ä»¶çš„å­˜å‚¨:

```js
putListener: function (inst, registrationName, listener) {
  // ç”¨æ¥æ ‡è¯†æ³¨å†Œäº†äº‹ä»¶,æ¯”å¦‚onClickçš„Reactå¯¹è±¡ã€‚keyçš„æ ¼å¼ä¸º'.nodeId', åªç”¨çŸ¥é“å®ƒå¯ä»¥æ ‡ç¤ºå“ªä¸ªReactå¯¹è±¡å°±å¯ä»¥äº†
  // step1: å¾—åˆ°ç»„ä»¶å”¯ä¸€æ ‡è¯†
  var key = getDictionaryKey(inst);

  // step2: å¾—åˆ°listenerBankå¯¹è±¡ä¸­æŒ‡å®šäº‹ä»¶ç±»å‹çš„å¯¹è±¡
  var bankForRegistrationName = listenerBank[registrationName] || (listenerBank[registrationName] = {});

  // step3: å°†listeneräº‹ä»¶å›è°ƒæ–¹æ³•å­˜å…¥listenerBank[registrationName][key]ä¸­,æ¯”å¦‚listenerBank['onclick'][nodeId]
  // æ‰€æœ‰Reactç»„ä»¶å¯¹è±¡å®šä¹‰çš„æ‰€æœ‰Reactäº‹ä»¶éƒ½ä¼šå­˜å‚¨åœ¨listenerBankä¸­
  bankForRegistrationName[key] = listener;

  // ...
}

// æ‹¿åˆ°ç»„ä»¶å”¯ä¸€æ ‡è¯†
var getDictionaryKey = function (inst) {
  return '.' + inst._rootNodeID;
};
```

## äº‹ä»¶åˆ†å‘

æ—¢ç„¶äº‹ä»¶å·²ç»å§”æ‰˜æ³¨å†Œåˆ°`document`ä¸Šäº†, é‚£ä¹ˆäº‹ä»¶è§¦å‘çš„æ—¶å€™, è‚¯å®šéœ€è¦ä¸€ä¸ªäº‹ä»¶åˆ†å‘çš„è¿‡ç¨‹, æµç¨‹ä¹Ÿå¾ˆç®€å•, æ—¢ç„¶äº‹ä»¶å­˜å‚¨åœ¨`listenerBank`, é‚£ä¹ˆæˆ‘å°±åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶ç±»å‹, ç„¶åæ‰§è¡Œäº‹ä»¶å›è°ƒå°±å¯ä»¥äº†. 

> æ³¨æ„, ç”±äºå…ƒç´ æœ¬èº«æ²¡æœ‰æ³¨å†Œä»»ä½•äº‹ä»¶, è€Œæ˜¯å§”æ‰˜åˆ°äº†documentä¸Š, æ‰€ä»¥è¿™ä¸ªå°†è¢«è§¦å‘çš„äº‹ä»¶æ˜¯Reactè‡ªå¸¦çš„åˆæˆäº‹ä»¶, è€Œéæµè§ˆå™¨åŸç”Ÿäº‹ä»¶.

é¦–å…ˆæ‰¾åˆ°äº‹ä»¶è§¦å‘çš„`DOM`å’Œ`React Component`, æ‰¾çœŸå®çš„DOMè¿˜æ˜¯æ¯”è¾ƒå¥½æ‰¾çš„, è¿™éƒ¨åˆ†ä»£ç åœ¨`getEventTag`ä¸­:

```js
// æºç çœ‹è¿™é‡Œ: https://github.com/facebook/react/blob/master/packages/react-dom/src/events/ReactDOMEventListener.js#L419
const nativeEventTarget = getEventTarget(nativeEvent)
let targetInst = getClosestInstanceFromNode(nativeEventTarget)

// ...
function getEventTarget(nativeEvent) {
  let target = nativeEvent.target || nativeEvent.srcElement || window

  if (target.correspondingUseElement) {
    target = target.correspondingUseElement
  }

  return target.nodeType === TEXT_NODE ? target.parentNode : target
}
```

è¿™ä¸ª`nativeEventTarget`å¯¹è±¡ä¸ŠæŒ‚è½½äº†ä¸€ä¸ªä»¥`__reactInernalInstance`å¼€å¤´çš„å±æ€§, è¿™ä¸ªå±æ€§å°±æ˜¯`internalInstanceKey`, å…¶å€¼å°±æ˜¯å½“å‰`React`å®ä¾‹å¯¹åº”çš„`React Component`.

```js
function dispatchEventForPluginEventSystem(
  topLevelType: DOMTopLevelEventType,
  eventSystemFlags: EventSystemFlags,
  nativeEvent: AnyNativeEvent,
  targetInst: null | Fiber
): void {
  const bookKeeping = getTopLevelCallbackBookKeeping(
    topLevelType,
    nativeEvent,
    targetInst,
    eventSystemFlags
  )

  try {
    // Event queue being processed in the same cycle allows
    // `preventDefault`.
    batchedEventUpdates(handleTopLevel, bookKeeping)
  } finally {
    releaseTopLevelCallbackBookKeeping(bookKeeping)
  }
}
```

`batchedEventUpdates()`æ‰¹é‡æ›´æ–°, å®ƒçš„å·¥ä½œæ˜¯æŠŠå½“å‰è§¦å‘çš„äº‹ä»¶æ”¾åœ¨äº†æ‰¹å¤„ç†é˜Ÿåˆ—ä¸­. `handleTopLevel`æ˜¯äº‹ä»¶åˆ†å‘çš„æ ¸å¿ƒæ‰€åœ¨.

```js
function handleTopLevel(bookKeeping: BookKeepingInstance) {
  let targetInst = bookKeeping.targetInst

  // Loop through the hierarchy, in case there's any nested components.
  // It's important that we build the array of ancestors before calling any
  // event handlers, because event handlers can modify the DOM, leading to
  // inconsistencies with ReactMount's node cache. See #1105.
  let ancestor = targetInst
  do {
    if (!ancestor) {
      const ancestors = bookKeeping.ancestors
      ;((ancestors: any): Array<Fiber | null>).push(ancestor)
      break
    }
    const root = findRootContainerNode(ancestor)
    if (!root) {
      break
    }
    const tag = ancestor.tag
    if (tag === HostComponent || tag === HostText) {
      bookKeeping.ancestors.push(ancestor)
    }
    ancestor = getClosestInstanceFromNode(root)
  } while (ancestor)
}
```

è¿™é‡Œçœ‹æ³¨é‡Š, è¯´çš„æ˜¯: äº‹ä»¶å›è°ƒå¯èƒ½ä¼šæ”¹å˜DOMç»“æ„, æ‰€ä»¥è¦å…ˆéå†å±‚ç†ç»“æ„, ä»¥é˜²å­˜åœ¨ä»»ä½•åµŒå¥—çš„ç»„ä»¶, ç„¶åç¼“å­˜èµ·æ¥.

ç„¶åç»§ç»­æ‰§è¡Œè¿™ä¸ªæ–¹æ³•:

```js
for (let i = 0; i < bookKeeping.ancestors.length; i++) {
  targetInst = bookKeeping.ancestors[i]
  // getEventTargetä¸Šè¾¹æœ‰è®²åˆ°
  const eventTarget = getEventTarget(bookKeeping.nativeEvent)
  const topLevelType = ((bookKeeping.topLevelType: any): DOMTopLevelEventType)
  const nativeEvent = ((bookKeeping.nativeEvent: any): AnyNativeEvent)

  runExtractedPluginEventsInBatch(
    topLevelType,
    targetInst,
    nativeEvent,
    eventTarget,
    bookKeeping.eventSystemFlags
  )
}
```

è¿™é‡Œç”¨äº†ä¸€ä¸ªforå¾ªç¯æ¥æ¯”é˜¿å°¼è¿™ä¸ªReact ComponentåŠå…¶æ‰€æœ‰çš„çˆ¶ç»„ä»¶, ç„¶åæ‰§è¡Œ`runExtractedPluginEventsInBatch`æ–¹æ³•. 

ä»è¿™é‡Œå¯ä»¥çœ‹å‡º, Reactè‡ªèº«å®ç°äº†ä¸€å¥—å†’æ³¡æœºåˆ¶, ä»è§¦å‘äº‹ä»¶çš„å¯¹è±¡å¼€å§‹, å‘çˆ¶å…ƒç´ å›æº¯, ä¸€æ¬¡è°ƒç”¨ä»–ä»¬æ³¨å†Œçš„æ—¶é—´çš„callback.

## äº‹ä»¶æ‰§è¡Œ

ä¸Šé¢æˆ‘ä»¬è®²åˆ°`runExtractedPluginEventsInBatch`å°±æ˜¯äº‹ä»¶æ‰§è¡Œçš„å…¥å£, é€šè¿‡æºç , ä»–ä¸»è¦åšäº†ä¸¤ä»¶äº‹:

- æ„é€ åˆæˆäº‹ä»¶
- æ‰¹å¤„ç†æ„é€ å‡ºæ¥çš„åˆæˆäº‹ä»¶

```js
export function runExtractedPluginEventsInBatch(
  topLevelType: TopLevelType,
  targetInst: null | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: EventTarget,
  eventSystemFlags: EventSystemFlags
) {
  // step1 : æ„é€ åˆæˆäº‹ä»¶
  const events = extractPluginEvents(
    topLevelType,
    targetInst,
    nativeEvent,
    nativeEventTarget,
    eventSystemFlags
  )

  // step2 : æ‰¹å¤„ç†
  runEventsInBatch(events)
}
```

### æ„é€ åˆæˆäº‹ä»¶

ç›¸å…³çš„ä»£ç åœ¨`extractPluginEvents()`å’Œ`runEventsInBatch()`ä¸­

```js
function extractPluginEvents(
  topLevelType: TopLevelType,
  targetInst: null | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: EventTarget,
  eventSystemFlags: EventSystemFlags
): Array<ReactSyntheticEvent> | ReactSyntheticEvent | null {
  let events = null
  for (let i = 0; i < plugins.length; i++) {
    // Not every plugin in the ordering may be loaded at runtime.
    const possiblePlugin: PluginModule<AnyNativeEvent> = plugins[i]
    if (possiblePlugin) {
      const extractedEvents = possiblePlugin.extractEvents(
        topLevelType,
        targetInst,
        nativeEvent,
        nativeEventTarget,
        eventSystemFlags
      )
      if (extractedEvents) {
        events = accumulateInto(events, extractedEvents)
      }
    }
  }
  return events
}
```

é¦–å…ˆå›å»éå†`plugins`, è¿™ä¸ª`plugins`å°±æ˜¯æ‰€æœ‰äº‹ä»¶åˆæˆ`plugins`çš„é›†åˆæ•°æ®, è¿™äº›pluginsæ˜¯åœ¨`EventPluginHub`åˆå§‹åŒ–æ—¶å€™æ³¨å…¥çš„. 

```js
// ğŸ“¢ æºç åœ°å€ : https://github.com/facebook/react/blob/master/packages/legacy-events/EventPluginHub.js#L80

export const injection = {
  injectEventPluginOrder,
  injectEventPluginsByName
}
```

```js
// ğŸ“¢ æºç åœ°å€ : https://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOMClientInjection.js#L26
EventPluginHubInjection.injectEventPluginOrder(DOMEventPluginOrder)

EventPluginHubInjection.injectEventPluginsByName({
  SimpleEventPlugin: SimpleEventPlugin,
  EnterLeaveEventPlugin: EnterLeaveEventPlugin,
  ChangeEventPlugin: ChangeEventPlugin,
  SelectEventPlugin: SelectEventPlugin,
  BeforeInputEventPlugin: BeforeInputEventPlugin
})
```

æˆ‘ä»¬ç»§ç»­çœ‹`extractEvent`çš„é€»è¾‘ä»£ç :

```js
const extractedEvents = possiblePlugin.extractEvents(
  topLevelType,
  targetInst,
  nativeEvent,
  nativeEventTarget,
  eventSystemFlags
)
if (extractedEvents) {
  events = accumulateInto(events, extractedEvents)
}
```

å› ä¸º`const possiblePlugin: PluginModule = plugins[i]`, ç±»å‹æ˜¯`PluginModule`, æˆ‘ä»¬å¯ä»¥å» `SimpleEventPlugin` æºç å»çœ‹ä¸€ä¸‹ `extractEvents` åˆ°åº•å¹²äº†å•¥:

```js
extractEvents: function() {
  const dispatchConfig = topLevelEventsToDispatchConfig[topLevelType]
  if (!dispatchConfig) {
    return null
  }
  //...
}
```

é¦–å…ˆ, çœ‹ä¸‹`topLevelEventsToDispatchConfig`è¿™ä¸ªå¯¹è±¡ä¸­æœ‰æ²¡æœ‰`topLevelType`è¿™ä¸ªå±æ€§, åªè¦æœ‰, é‚£ä¹ˆè¯´æ˜å½“å‰äº‹ä»¶å¯ä»¥ä½¿ç”¨`SimpleEventPlugin`æ„é€ åˆæˆäº‹ä»¶.

å‡½æ•°ä¸­é¡¶ä¸€ä¸ª`EventConstructor`, ç„¶åé€šè¿‡`switch..case`è¿›è¡Œèµ‹å€¼:

```js
extractEvents: function() {
  //...
  let EventConstructor
  switch (topLevelType) {
    // ...
    case DOMTopLevelEventTypes.TOP_POINTER_UP:
      EventConstructor = SyntheticPointerEvent
      break
    default:
      EventConstructor = SyntheticEvent
      break
  }
}
```

æ€»ä¹‹èµ‹å€¼ç»™`EventConstructor`. 

è®¾ç½®å¥½äº†`EventConstructor`ä¹‹å, è¿™ä¸ªæ–¹æ³•ç»§ç»­æ‰§è¡Œ:

```js
extractEvents: function() {
  //...
  const event = EventConstructor.getPooled(
    dispatchConfig,
    targetInst,
    nativeEvent,
    nativeEventTarget
  )
  accumulateTwoPhaseDispatches(event)
  return event
}
```

è¿™æ®µä»£ç çš„æ„æ€æ˜¯: ä»eventå¯¹è±¡æ± ä¸­å–å‡ºåˆæˆäº‹ä»¶, è¿™é‡Œçš„`getPooled()`æ–¹æ³•, å…¶å®åœ¨`SyntheticEvent`åˆå§‹åŒ–çš„æ—¶å€™å°±è¢«è®¾ç½®å¥½äº†:

```js
function addEventPoolingTo(EventConstructor) {
  EventConstructor.eventPool = []
  // å°±æ˜¯è¿™é‡Œè®¾ç½®äº†getPooled
  EventConstructor.getPooled = getPooledEvent
  EventConstructor.release = releasePooledEvent
}

SyntheticEvent.extend = function(Interface) {
  //...
  addEventPoolingTo(Class)

  return Class
}

addEventPoolingTo(SyntheticEvent)
```

çœ‹åˆ°è¿™é‡Œ, æˆ‘ä»¬çŸ¥é“`getPooled`å°±æ˜¯`getPooledEvent`:

```js
function getPooledEvent(dispatchConfig, targetInst, nativeEvent, nativeInst) {
  const EventConstructor = this
  if (EventConstructor.eventPool.length) {
    const instance = EventConstructor.eventPool.pop()
    EventConstructor.call(
      instance,
      dispatchConfig,
      targetInst,
      nativeEvent,
      nativeInst
    )
    return instance
  }
  return new EventConstructor(
    dispatchConfig,
    targetInst,
    nativeEvent,
    nativeInst
  )
}
```

é¦–å…ˆ, ä¼šå…ˆåˆ°å¯¹è±¡æ± ä¸­, çœ‹ä¸€ä¸‹lengthæ˜¯å¦ä¸º0, å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡äº‹ä»¶è§¦å‘, é‚£éœ€è¦`new EventConstructor`, å¦‚æœåç»­å†æ¬¡è§¦å‘äº‹ä»¶, åˆ™ç›´æ¥ä»å¯¹è±¡æ± ä¸­å–, ä¹Ÿå°±æ˜¯ç›´æ¥`instance = EventConstructor.eventPool.pop()`å°±å¯ä»¥äº†. 

äº‹ä»¶æ‰§è¡Œè¿˜æœ‰å¦ä¸€ä¸ªé‡è¦æ“ä½œ: æ‰¹å¤„ç† runEventsInBatch(events)

### æ‰¹å¤„ç†

æ‰¹å¤„ç†ä¸»è¦æ˜¯é€šè¿‡ `runEventQueueInBatch(events)` è¿›è¡Œçš„:

```js
export function runEventsInBatch(
  events: Array<ReactSyntheticEvent> | ReactSyntheticEvent | null
) {
  if (events !== null) {
    eventQueue = accumulateInto(eventQueue, events)
  }

  // Set `eventQueue` to null before processing it so that we can tell if more
  // events get enqueued while processing.
  const processingEventQueue = eventQueue
  eventQueue = null

  if (!processingEventQueue) {
    return
  }

  forEachAccumulated(processingEventQueue, executeDispatchesAndReleaseTopLevel)
  invariant(
    !eventQueue,
    'processEventQueue(): Additional events were enqueued while processing ' +
      'an event queue. Support for this has not yet been implemented.'
  )
  // This would be a good time to rethrow if any of the event handlers threw.
  rethrowCaughtError()
}
```

è¿™ä¸ªæ–¹æ³•é¦–å…ˆå°†å½“å‰éœ€è¦å¤„ç†çš„eventsäº‹ä»¶, ä¸ä¹‹å‰æ²¡æœ‰å¤„ç†å®Œæ¯•çš„é˜Ÿåˆ—è°ƒç”¨`accumulateInto`æ–¹æ³•æŒ‰ç…§é¡ºåºè¿›è¡Œåˆå¹¶, ç»„æˆä¸€ä¸ªæ–°çš„é˜Ÿåˆ—

å¦‚æœ`processingEventQueue`è¿™ä¸ªä¸ºç©º, åˆ™è¡¨ç¤ºæ²¡æœ‰å¤„ç†çš„äº‹ä»¶, é€€å‡º, å¦åˆ™è°ƒç”¨`forEacgAccumulated()`:

```js
function forEachAccumulated<T>(
  arr: ?(Array<T> | T),
  cb: (elem: T) => void,
  scope: ?any
) {
  if (Array.isArray(arr)) {
    arr.forEach(cb, scope)
  } else if (arr) {
    cb.call(scope, arr)
  }
}
```

è¿™ä¸ªæ–¹æ³•å°±æ˜¯çœ‹ä¸‹äº‹ä»¶é˜Ÿåˆ—æ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°ç»„, å¦‚æœæ˜¯, åˆ™è¯´æ˜éœ€è¦éå†é˜Ÿåˆ—, è°ƒç”¨`executeDispatchesAndReleaseTopLevel`æ–¹æ³•, å¦åˆ™è¯´æ˜é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªäº‹ä»¶, åˆ™æ— éœ€éå†ç›´æ¥è°ƒç”¨å³å¯. 

```js
const executeDispatchesAndRelease = function(event: ReactSyntheticEvent) {
  if (event) {
    executeDispatchesInOrder(event)

    if (!event.isPersistent()) {
      event.constructor.release(event)
    }
  }
}
const executeDispatchesAndReleaseTopLevel = function(e) {
  return executeDispatchesAndRelease(e)
}
```

```js
export function executeDispatchesInOrder(event) {
  const dispatchListeners = event._dispatchListeners
  const dispatchInstances = event._dispatchInstances
  if (__DEV__) {
    validateEventDispatches(event)
  }
  if (Array.isArray(dispatchListeners)) {
    for (let i = 0; i < dispatchListeners.length; i++) {
      if (event.isPropagationStopped()) {
        break
      }
      // Listeners and Instances are two parallel arrays that are always in sync.
      executeDispatch(event, dispatchListeners[i], dispatchInstances[i])
    }
  } else if (dispatchListeners) {
    executeDispatch(event, dispatchListeners, dispatchInstances)
  }
  event._dispatchListeners = null
  event._dispatchInstances = null
}
```

é¦–å…ˆæ‹¿åˆ°äº‹ä»¶ä¸ŠæŒ‚è½½çš„`dispatchListeners`, å°±æ˜¯æ‰€æœ‰æ³¨å†Œäº‹ä»¶å›è°ƒå‡½æ•°çš„é›†åˆ, éå†è¿™ä¸ªé›†åˆ, å¦‚æœ`event.isPropagationStopped() = ture`, é‚£å°±ç›´æ¥é€€å‡º, è¯´æ˜åœ¨æ­¤ä¹‹å‰è§¦å‘çš„äº‹ä»¶å·²ç»è°ƒç”¨äº†`event.stopPropagation()`, `isPropagationStopped`çš„å€¼è¢«ç½®ä¸º`true`, å½“å‰äº‹ä»¶ä»¥åŠåé¢çš„äº‹ä»¶ä½œä¸ºçˆ¶çº§äº‹ä»¶å°±ä¸åº”è¯¥å†è¢«æ‰§è¡Œäº†.

è¿™é‡Œå½“`event.isPropagationStopped()`ä¸º`true`æ—¶ï¼Œä¸­æ–­åˆæˆäº‹ä»¶çš„å‘ä¸Šéå†æ‰§è¡Œï¼Œä¹Ÿå°±èµ·åˆ°äº†å’ŒåŸç”Ÿäº‹ä»¶è°ƒç”¨ `stopPropagation`ç›¸åŒçš„æ•ˆæœ å¦‚æœå¾ªç¯æ²¡æœ‰è¢«ä¸­æ–­ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ`executeDispatch`æ–¹æ³•. 

## å‚è€ƒé“¾æ¥

- [ç”±æµ…åˆ°æ·±çš„Reactåˆæˆäº‹ä»¶](https://juejin.cn/post/6844903988794671117)