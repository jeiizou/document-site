# 契约原则

> 契约设计: 如何做好API接口设计

## 契约式设计原则

契约式设计原则(Design by Contract, DbC), 原理是: **在软件设计时应该为软件组件定义一种精确和可验证的接口规范，这种规范要包括使用的预置条件、后置条件和不变条件，用来扩展普通抽象数据类型的定义。**

在web中:

- 预置条件: 主要用于处理输入的参数校验
- 不变条件: 指一个请求中的共享数据状态
- 后置条件: 对返回的相应数据的检查与确认

能够设计要一个API, 需要回答三个问题:

- API的期望是什么
- API要保证的是什么
- API要保持不变的是什么

这三个问题的本质就是契约原则的一种最佳实践:

1. API必须保证输入是接受者期望的输入条件
2. API 必须要保证输出结果的正确性
3. API 必须要保持处理过程中的一致性

为什么一定使用契约原则来指导 API 的编程和设计呢？其实主要有以下三个原因:

- 提前告知 API 有哪些约束会让你在编码过程中节省很多不必要的沟通成本
- 契约会强迫你去思考 API 是否满足更好的独立性
- 契约式设计会提醒你应该保证 API 的高可用性

## 如何做好API接口设计

1. 让接口职责分离: 尽量找到变化相似的职责来进行封装
2. API的命名很重要:
   1. 使用英文的小写
   2. 使用被大家都接受的通用缩写
   3. 通过命名含义描述接口
3. 尽量少创造自定义错误码
4. 同一接口到做到幂等: 当一个操作多次执行所产生的的影响均与一次执行的影响相同.
   1. 分散性的服务会带来一个问题: 多个服务在同一时间可能会并行修改同一份数据
   2. 如何做到幂等呢?
      1. 使用天然幂等的操作
      2. 使用唯一键值
      3. 使用加锁策略
      4. 使用Source+Token验证机制
      5. 使用有限状态机
5. 安全策略: 
   1. 在内部系统, 多考虑输入和输出数据的准确性
   2. 对于外部系统, 针对安全攻击, 错误调用, 接口滥用需要进行处理
6. 版本管理


